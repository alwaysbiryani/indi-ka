name: Build Verification & Legacy UI Guard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify-mobile-first-ui:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: ğŸ” Verify no legacy UI patterns
        run: |
          echo "ğŸ” Scanning for legacy UI patterns..."
          
          # Check for forbidden legacy patterns
          if grep -r "desktop-view\|legacy\|old-ui\|website-mode\|desktop-only" src/ --include="*.tsx" --include="*.ts" 2>/dev/null; then
            echo "âŒ CRITICAL: Legacy UI patterns detected!"
            echo "âŒ Mobile-first UI must be the only UI"
            exit 1
          fi
          
          # Verify single page.tsx exists
          if [ ! -f "src/app/page.tsx" ]; then
            echo "âŒ CRITICAL: Main page.tsx missing!"
            exit 1
          fi
          
          # Count page files (should be exactly 1 in app directory)
          PAGE_COUNT=$(find src/app -name "page.tsx" -type f | wc -l | tr -d ' ')
          if [ "$PAGE_COUNT" -ne 1 ]; then
            echo "âŒ CRITICAL: Multiple page.tsx files detected!"
            echo "Expected 1, found $PAGE_COUNT"
            exit 1
          fi
          
          # Verify mobile-first marker exists
          if ! grep -q "mobile-first" src/app/layout.tsx; then
            echo "âš ï¸  WARNING: mobile-first marker not found in layout"
          fi
          
          echo "âœ… No legacy UI patterns found"
          echo "âœ… Single page.tsx verified"
          echo "âœ… Mobile-first UI is the only UI"
          
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ğŸ“¦ Verify build output
        run: |
          echo "ğŸ” Verifying build output..."
          
          if [ ! -d ".next" ]; then
            echo "âŒ Build output directory missing!"
            exit 1
          fi
          
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âŒ BUILD_ID file missing!"
            exit 1
          fi
          
          BUILD_ID=$(cat .next/BUILD_ID)
          echo "âœ… Build ID: $BUILD_ID"
          
          # Check for static generation
          if [ ! -d ".next/static" ]; then
            echo "âŒ Static assets directory missing!"
            exit 1
          fi
          
          echo "âœ… Build output verified"
          
      - name: ğŸ“Š Check bundle size
        run: |
          echo "ğŸ“¦ Analyzing bundle size..."
          du -sh .next/static/chunks/ 2>/dev/null || echo "No chunks directory"
          du -sh .next/ 2>/dev/null || echo "No .next directory"
          
      - name: âœ… Success notification
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… BUILD VERIFICATION PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… No legacy UI detected"
          echo "âœ… Mobile-first UI is the only UI"
          echo "âœ… Build completed successfully"
          echo "âœ… Ready for deployment to production"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
